#!/usr/bin/env rakudo

use lib 'lib';
use lib '.';
use plot;
use util;
use Conf;

sub MAIN($dirs, $gpu = 0, $tmp_dir="/sdnv1/t1") 
{
    my $conf  = Conf.new;	
    my @disks = parse($dirs);
    my $path = "";    
    my $addr  = $conf.addr;
    my $level = $conf.nossd_level;
    say $level, $addr;
    my $num   = (^10000).pick;
    my $spath = '~/s' ~ $num;
    say $spath;

    for @disks -> $d {
	    say "dir: $d" ;
	    my $f_dir = '/sd' ~ $d ~ '/' ~ 'plots/';
            if ($conf.nossd_mining) {
	       $path = $path ~ '-d,r ' ~ $f_dir ~ " ";
	    } else {
	       $path = $path ~ '-d,~t ' ~ $f_dir ~ " ";
	    }
    }
    if ($conf.nossd_mining) {
       say "mining mode";
       say "qqx/tmux new -s mining -d client $path -a $addr/";
       my $sname = 'plot_' ~ $num;
       qqx/tmux new -s $sname -d client $path -a $addr -s $spath/;
    } else {
       say "ploting mode";
       if ($conf.notmp) {
       	    $path = $path ~ ' --no-temp ';            
       } else {
       	    $path = $path ~ '-d,t ' ~ $tmp_dir;
       }
       say $path;
       my $sname = 'plot_' ~ $num;
       say "qqx/tmux new -s $sname -d client $path -c $level -a $addr -s $spath -g $gpu -x $gpu --no-gpu-mining/";
       qqx/tmux new -s $sname -d client $path -c $level -a $addr -s $spath -g $gpu -x $gpu --no-gpu-mining/;
    }
}
